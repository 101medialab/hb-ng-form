export class TypeMeta {
    constructor(_type) {
        this._type = _type;
    }
    get type() {
        return this._type;
    }
}
export class PrimitiveTypeMeta extends TypeMeta {
    constructor(_value) {
        super(([
            'string',
            'number',
            'boolean'
        ].indexOf(typeof _value) > -1 ? typeof _value : 'any'));
        this._value = _value;
    }
    get value() {
        return this._value;
    }
}
export class NonPrimitiveTypeMeta extends TypeMeta {
    constructor(type, _mapping = null, // All attributes should be type of ExtractorResultType
    _value = null) {
        super(type);
        this._mapping = _mapping;
        this._value = _value;
    }
    get mapping() {
        return this._mapping;
    }
    get value() {
        return this._value;
    }
}
const OnOATResolvedSymbol = 'OnOATResolved';
export function OnOATResolved(cb) {
    return Reflect.metadata(OnOATResolvedSymbol, cb);
}
export class ObjectAttributeTypeExtractor {
    static generateMapping(input, options = {}) {
        options = Object.assign({
            keyNamingStrategy: 'camelCase',
            stripUnderscore: false
        }, options);
        let mapping = {};
        let result = null;
        // input is an array, analyze the first cell only
        if (input instanceof Array) {
            mapping = new NonPrimitiveTypeMeta('array', Extractor.generateMapping(input[0], options));
        }
        else {
            // Analyze attributes inside input object
            for (let key in input) {
                if (typeof input[key] !== 'function') {
                    let resolvedMeta = {};
                    // Array or Object
                    if (typeof input[key] === 'object') {
                        resolvedMeta = Extractor.generateObjectTypeMapping(input, key, options);
                        // Any primitive type
                    }
                    else if (typeof input[key] !== 'function') {
                        resolvedMeta = new PrimitiveTypeMeta(input[key]);
                    }
                    if (Reflect.hasMetadata(OnOATResolvedSymbol, input, key)) {
                        Reflect.getMetadata(OnOATResolvedSymbol, input, key)(input, key, resolvedMeta);
                    }
                    else if (typeof options.onResolved === 'function') {
                        options.onResolved(input, key, resolvedMeta);
                    }
                    // Finished, set resolved attribute metadata to result
                    mapping[Extractor.resolveAttributeKey(options, key, input)] = resolvedMeta;
                }
            }
        }
        if (typeof input === 'object') {
            if (!(input instanceof Date) && !(input instanceof Array)) {
                result = new NonPrimitiveTypeMeta('object', mapping);
            }
            else {
                result = mapping;
            }
        }
        else {
            result = { mapping };
        }
        if (Reflect.hasMetadata(OnOATResolvedSymbol, input.constructor)) {
            Reflect.getMetadata(OnOATResolvedSymbol, input.constructor)(input.constructor, null, result);
        }
        else if (typeof options.onResolved === 'function') {
            options.onResolved(input, null, result);
        }
        return result;
    }
    static generateObjectTypeMapping(object, key, options) {
        let resolvedMeta = null;
        // Mark type as any if value is null
        if (object[key] === null) {
            resolvedMeta = new PrimitiveTypeMeta(null);
            // For Array
        }
        else if (object[key] instanceof Array) {
            let target = object[key];
            // For Primitive Array
            if (typeof target[0] !== 'object') {
                resolvedMeta = new NonPrimitiveTypeMeta('array', new PrimitiveTypeMeta(target[0]));
                // For Object Array
            }
            else {
                resolvedMeta = Extractor.generateMapping(target, options);
            }
            // For Date
        }
        else if (object[key] instanceof Date) {
            resolvedMeta = new NonPrimitiveTypeMeta('date', null, object[key]);
            // For Object
        }
        else {
            resolvedMeta = Extractor.generateMapping(object[key], options);
        }
        return resolvedMeta;
    }
    static resolveAttributeKey(options, key, object) {
        let setterKey = key;
        // if set function exists, rename _attr to attr
        if (options.stripUnderscore && key.charAt(0) === '_') {
            let trimmedKey = key.substr(1, key.length);
            if (trimmedKey in object) {
                setterKey = trimmedKey;
            }
        }
        // Some serializer serialize data with snake_case
        // but JS Entity Classes name attributes with camelCase
        if (options.keyNamingStrategy === 'snake_case') {
            setterKey = Extractor.convertStringToSnakeCase(setterKey);
        }
        return setterKey;
    }
    // For naming convention changing. Not really related to this extractor
    static fixNamingConvention(data, options) {
        let result = null;
        options = Object.assign({
            keyNamingStrategy: 'camelCase',
            stripUnderscore: false
        }, options);
        if (data instanceof Array) {
            result = [];
            data.forEach(function (obj) {
                result.push(Extractor.fixNamingConvention(obj, options));
            });
        }
        else if (typeof data === 'object') {
            result = {};
            for (let key in data) {
                if (!options.stripUnderscore || key.charAt(0) !== '_') {
                    let finalKey = key;
                    if (options.keyNamingStrategy === 'snake_case') {
                        finalKey = Extractor.convertStringToSnakeCase(key);
                    }
                    if (typeof data[key] === 'object') {
                        result[finalKey] = Extractor.fixNamingConvention(data[key], options);
                    }
                    else {
                        result[finalKey] = data[key];
                    }
                }
            }
        }
        return result;
    }
    // For JSON editor only. Should be extracted.
    static convertDataToString(data, callbacks = {}) {
        let result = null;
        if (data instanceof Array) {
            result = [];
            data.forEach(function (obj) {
                result.push(Extractor.convertDataToString(obj));
            });
        }
        else if (typeof data === 'object') {
            result = {};
            for (let key in data) {
                if (typeof data[key] === 'object') {
                    if (data[key] instanceof Date) {
                        result[key] =
                            'date' in callbacks &&
                                callbacks.date instanceof Function ?
                                callbacks.date(data[key]) : data[key].yyyymmdd('-');
                    }
                    else {
                        result[key] = Extractor.convertDataToString(data[key]);
                    }
                }
                else if (typeof data[key] !== 'function') {
                    result[key] = data[key];
                }
            }
        }
        return result;
    }
    static convertStringToSnakeCase(value) {
        const result = value.replace(/([A-Z]+)/g, "_$1").toLowerCase();
        return result;
    }
}
let Extractor = ObjectAttributeTypeExtractor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JqZWN0QXR0cmlidXRlVHlwZUV4dHJhY3Rvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2hiLW5nLWZvcm0vIiwic291cmNlcyI6WyJsaWIvT2JqZWN0QXR0cmlidXRlVHlwZUV4dHJhY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxNQUFNLE9BQU8sUUFBUTtJQUNqQixZQUFzQixLQUFvQjtRQUFwQixVQUFLLEdBQUwsS0FBSyxDQUFlO0lBQUcsQ0FBQztJQUU5QyxJQUFJLElBQUk7UUFDSixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztDQUNKO0FBRUQsTUFBTSxPQUFPLGlCQUFrQixTQUFRLFFBQVE7SUFDM0MsWUFDYyxNQUFXO1FBRXJCLEtBQUssQ0FDYyxDQUFDO1lBQ1osUUFBUTtZQUNSLFFBQVE7WUFDUixTQUFTO1NBQ1osQ0FBQyxPQUFPLENBQUMsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RCxDQUFDO1FBUlEsV0FBTSxHQUFOLE1BQU0sQ0FBSztJQVN6QixDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ0wsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7Q0FDSjtBQUVELE1BQU0sT0FBTyxvQkFBcUIsU0FBUSxRQUFRO0lBQzlDLFlBQ0ksSUFBaUMsRUFDekIsV0FBZ0IsSUFBSSxFQUFFLHVEQUF1RDtJQUM3RSxTQUFjLElBQUk7UUFFMUIsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBSEosYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUNwQixXQUFNLEdBQU4sTUFBTSxDQUFZO0lBRzlCLENBQUM7SUFFRCxJQUFJLE9BQU87UUFDUCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDekIsQ0FBQztJQUVELElBQUksS0FBSztRQUNMLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFD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eXBlID0gJ3N0cmluZycgfCAnbnVtYmVyJyB8ICdib29sZWFuJyB8ICdkYXRlJyB8ICdhcnJheScgfCAnb2JqZWN0JyB8ICdhbnknO1xuXG5leHBvcnQgY2xhc3MgVHlwZU1ldGEge1xuICAgIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBfdHlwZTogQXR0cmlidXRlVHlwZSkge31cblxuICAgIGdldCB0eXBlKCk6IEF0dHJpYnV0ZVR5cGUge1xuICAgICAgICByZXR1cm4gdGhpcy5fdHlwZTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQcmltaXRpdmVUeXBlTWV0YSBleHRlbmRzIFR5cGVNZXRhIHtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIF92YWx1ZTogYW55XG4gICAgKSB7XG4gICAgICAgIHN1cGVyKFxuICAgICAgICAgICAgPEF0dHJpYnV0ZVR5cGU+KFtcbiAgICAgICAgICAgICAgICAnc3RyaW5nJyxcbiAgICAgICAgICAgICAgICAnbnVtYmVyJyxcbiAgICAgICAgICAgICAgICAnYm9vbGVhbidcbiAgICAgICAgICAgIF0uaW5kZXhPZih0eXBlb2YgX3ZhbHVlKSA+IC0xID8gdHlwZW9mIF92YWx1ZSA6ICdhbnknKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGdldCB2YWx1ZSgpOiBhbnkge1xuICAgICAgICByZXR1cm4gdGhpcy5fdmFsdWU7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTm9uUHJpbWl0aXZlVHlwZU1ldGEgZXh0ZW5kcyBUeXBlTWV0YSB7XG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHR5cGU6ICdvYmplY3QnIHwgJ2FycmF5JyB8ICdkYXRlJyxcbiAgICAgICAgcHJpdmF0ZSBfbWFwcGluZzogYW55ID0gbnVsbCwgLy8gQWxsIGF0dHJpYnV0ZXMgc2hvdWxkIGJlIHR5cGUgb2YgRXh0cmFjdG9yUmVzdWx0VHlwZVxuICAgICAgICBwcml2YXRlIF92YWx1ZTogYW55ID0gbnVsbFxuICAgICkge1xuICAgICAgICBzdXBlcih0eXBlKTtcbiAgICB9XG5cbiAgICBnZXQgbWFwcGluZygpOiBFeHRyYWN0b3JSZXN1bHRUeXBlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21hcHBpbmc7XG4gICAgfVxuXG4gICAgZ2V0IHZhbHVlKCk6IGFueSB7XG4gICAgICAgIHJldHVybiB0aGlzLl92YWx1ZTtcbiAgICB9XG59XG5cbmV4cG9ydCB0eXBlIEV4dHJhY3RvclJlc3VsdFR5cGUgPSBOb25QcmltaXRpdmVUeXBlTWV0YSB8IFByaW1pdGl2ZVR5cGVNZXRhO1xuXG5jb25zdCBPbk9BVFJlc29sdmVkU3ltYm9sID0gJ09uT0FUUmVzb2x2ZWQnO1xuXG5leHBvcnQgZnVuY3Rpb24gT25PQVRSZXNvbHZlZChjYjogKHRhcmdldDogYW55LCBrZXk6IHN0cmluZywgcmVzb2x2ZWQ6IGFueSkgPT4gdm9pZCkge1xuICAgIHJldHVybiBSZWZsZWN0Lm1ldGFkYXRhKE9uT0FUUmVzb2x2ZWRTeW1ib2wsIGNiKTtcbn1cblxuZXhwb3J0IGNsYXNzIE9iamVjdEF0dHJpYnV0ZVR5cGVFeHRyYWN0b3Ige1xuICAgIHN0YXRpYyBnZW5lcmF0ZU1hcHBpbmcoXG4gICAgICAgIGlucHV0OiBhbnksXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIGtleU5hbWluZ1N0cmF0ZWd5PzogJ2NhbWVsQ2FzZScgfCAnc25ha2VfY2FzZScsXG4gICAgICAgICAgICBzdHJpcFVuZGVyc2NvcmU/OiBib29sZWFuLFxuICAgICAgICAgICAgb25SZXNvbHZlZD86ICh0YXJnZXQ6IGFueSwga2V5Pzogc3RyaW5nLCByZXNvbHZlZD86IGFueSkgPT4gdm9pZFxuICAgICAgICB9ID0ge31cbiAgICApOiBhbnkge1xuICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgICBrZXlOYW1pbmdTdHJhdGVneTogJ2NhbWVsQ2FzZScsXG4gICAgICAgICAgICBzdHJpcFVuZGVyc2NvcmU6IGZhbHNlXG4gICAgICAgIH0sIG9wdGlvbnMpO1xuXG4gICAgICAgIGxldCBtYXBwaW5nOiBhbnkgPSB7fTtcbiAgICAgICAgbGV0IHJlc3VsdDogYW55ID0gbnVsbDtcblxuICAgICAgICAvLyBpbnB1dCBpcyBhbiBhcnJheSwgYW5hbHl6ZSB0aGUgZmlyc3QgY2VsbCBvbmx5XG4gICAgICAgIGlmIChpbnB1dCBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICBtYXBwaW5nID0gbmV3IE5vblByaW1pdGl2ZVR5cGVNZXRhKFxuICAgICAgICAgICAgICAgICdhcnJheScsXG4gICAgICAgICAgICAgICAgRXh0cmFjdG9yLmdlbmVyYXRlTWFwcGluZyhpbnB1dFswXSwgb3B0aW9ucylcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBBbmFseXplIGF0dHJpYnV0ZXMgaW5zaWRlIGlucHV0IG9iamVjdFxuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIGlucHV0KSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dFtrZXldICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXNvbHZlZE1ldGE6IGFueSA9IHt9O1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIEFycmF5IG9yIE9iamVjdFxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlucHV0W2tleV0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZE1ldGEgPSBFeHRyYWN0b3IuZ2VuZXJhdGVPYmplY3RUeXBlTWFwcGluZyhpbnB1dCwga2V5LCBvcHRpb25zKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBBbnkgcHJpbWl0aXZlIHR5cGVcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXRba2V5XSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRNZXRhID0gbmV3IFByaW1pdGl2ZVR5cGVNZXRhKGlucHV0W2tleV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKFJlZmxlY3QuaGFzTWV0YWRhdGEoT25PQVRSZXNvbHZlZFN5bWJvbCwgaW5wdXQsIGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFJlZmxlY3QuZ2V0TWV0YWRhdGEoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgT25PQVRSZXNvbHZlZFN5bWJvbCwgaW5wdXQsIGtleVxuICAgICAgICAgICAgICAgICAgICAgICAgKShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dCwga2V5LCByZXNvbHZlZE1ldGFcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMub25SZXNvbHZlZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5vblJlc29sdmVkKGlucHV0LCBrZXksIHJlc29sdmVkTWV0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBGaW5pc2hlZCwgc2V0IHJlc29sdmVkIGF0dHJpYnV0ZSBtZXRhZGF0YSB0byByZXN1bHRcbiAgICAgICAgICAgICAgICAgICAgbWFwcGluZ1tcbiAgICAgICAgICAgICAgICAgICAgICAgIEV4dHJhY3Rvci5yZXNvbHZlQXR0cmlidXRlS2V5KG9wdGlvbnMsIGtleSwgaW5wdXQpXG4gICAgICAgICAgICAgICAgICAgIF0gPSByZXNvbHZlZE1ldGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgdHlwZW9mIGlucHV0ID09PSAnb2JqZWN0J1xuICAgICAgICApIHtcbiAgICAgICAgICAgIGlmICghKGlucHV0IGluc3RhbmNlb2YgRGF0ZSkgJiYgIShpbnB1dCBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBOb25QcmltaXRpdmVUeXBlTWV0YSgnb2JqZWN0JywgbWFwcGluZyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IG1hcHBpbmc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQgPSB7IG1hcHBpbmcgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChSZWZsZWN0Lmhhc01ldGFkYXRhKE9uT0FUUmVzb2x2ZWRTeW1ib2wsIGlucHV0LmNvbnN0cnVjdG9yKSkge1xuICAgICAgICAgICAgUmVmbGVjdC5nZXRNZXRhZGF0YShcbiAgICAgICAgICAgICAgICBPbk9BVFJlc29sdmVkU3ltYm9sLCBpbnB1dC5jb25zdHJ1Y3RvclxuICAgICAgICAgICAgKShcbiAgICAgICAgICAgICAgICBpbnB1dC5jb25zdHJ1Y3RvciwgbnVsbCwgcmVzdWx0XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zLm9uUmVzb2x2ZWQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG9wdGlvbnMub25SZXNvbHZlZChpbnB1dCwgbnVsbCwgcmVzdWx0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHRcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2VuZXJhdGVPYmplY3RUeXBlTWFwcGluZyhvYmplY3Q6IGFueSwga2V5LCBvcHRpb25zOiBhbnkpIHtcbiAgICAgICAgbGV0IHJlc29sdmVkTWV0YSA9IG51bGw7XG5cbiAgICAgICAgLy8gTWFyayB0eXBlIGFzIGFueSBpZiB2YWx1ZSBpcyBudWxsXG4gICAgICAgIGlmIChvYmplY3Rba2V5XSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzb2x2ZWRNZXRhID0gbmV3IFByaW1pdGl2ZVR5cGVNZXRhKG51bGwpO1xuXG4gICAgICAgIC8vIEZvciBBcnJheVxuICAgICAgICB9IGVsc2UgaWYgKG9iamVjdFtrZXldIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgIGxldCB0YXJnZXQgPSBvYmplY3Rba2V5XTtcbiAgICAgICAgICAgIC8vIEZvciBQcmltaXRpdmUgQXJyYXlcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0WzBdICE9PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIHJlc29sdmVkTWV0YSA9IG5ldyBOb25QcmltaXRpdmVUeXBlTWV0YSgnYXJyYXknLCBuZXcgUHJpbWl0aXZlVHlwZU1ldGEodGFyZ2V0WzBdKSk7XG4gICAgICAgICAgICAvLyBGb3IgT2JqZWN0IEFycmF5XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc29sdmVkTWV0YSA9IEV4dHJhY3Rvci5nZW5lcmF0ZU1hcHBpbmcodGFyZ2V0LCBvcHRpb25zKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAvLyBGb3IgRGF0ZVxuICAgICAgICB9IGVsc2UgaWYgKG9iamVjdFtrZXldIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgICAgcmVzb2x2ZWRNZXRhID0gbmV3IE5vblByaW1pdGl2ZVR5cGVNZXRhKCdkYXRlJywgbnVsbCwgb2JqZWN0W2tleV0pO1xuXG4gICAgICAgIC8vIEZvciBPYmplY3RcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmVkTWV0YSA9IEV4dHJhY3Rvci5nZW5lcmF0ZU1hcHBpbmcob2JqZWN0W2tleV0sIG9wdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmVkTWV0YTtcbiAgICB9XG5cbiAgICBzdGF0aWMgcmVzb2x2ZUF0dHJpYnV0ZUtleShvcHRpb25zOiBhbnksIGtleSwgb2JqZWN0OiBhbnkpIHtcbiAgICAgICAgbGV0IHNldHRlcktleSA9IGtleTtcblxuICAgICAgICAvLyBpZiBzZXQgZnVuY3Rpb24gZXhpc3RzLCByZW5hbWUgX2F0dHIgdG8gYXR0clxuICAgICAgICBpZiAob3B0aW9ucy5zdHJpcFVuZGVyc2NvcmUgJiYga2V5LmNoYXJBdCgwKSA9PT0gJ18nKSB7XG4gICAgICAgICAgICBsZXQgdHJpbW1lZEtleSA9IGtleS5zdWJzdHIoMSwga2V5Lmxlbmd0aCk7XG5cbiAgICAgICAgICAgIGlmICh0cmltbWVkS2V5IGluIG9iamVjdCkge1xuICAgICAgICAgICAgICAgIHNldHRlcktleSA9IHRyaW1tZWRLZXk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTb21lIHNlcmlhbGl6ZXIgc2VyaWFsaXplIGRhdGEgd2l0aCBzbmFrZV9jYXNlXG4gICAgICAgIC8vIGJ1dCBKUyBFbnRpdHkgQ2xhc3NlcyBuYW1lIGF0dHJpYnV0ZXMgd2l0aCBjYW1lbENhc2VcbiAgICAgICAgaWYgKG9wdGlvbnMua2V5TmFtaW5nU3RyYXRlZ3kgPT09ICdzbmFrZV9jYXNlJykge1xuICAgICAgICAgICAgc2V0dGVyS2V5ID0gRXh0cmFjdG9yLmNvbnZlcnRTdHJpbmdUb1NuYWtlQ2FzZShzZXR0ZXJLZXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHNldHRlcktleTtcbiAgICB9XG5cbiAgICAvLyBGb3IgbmFtaW5nIGNvbnZlbnRpb24gY2hhbmdpbmcuIE5vdCByZWFsbHkgcmVsYXRlZCB0byB0aGlzIGV4dHJhY3RvclxuICAgIHN0YXRpYyBmaXhOYW1pbmdDb252ZW50aW9uKGRhdGE6IGFueSwgb3B0aW9uczogYW55KSB7XG4gICAgICAgIGxldCByZXN1bHQgPSBudWxsO1xuICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgICBrZXlOYW1pbmdTdHJhdGVneTogJ2NhbWVsQ2FzZScsXG4gICAgICAgICAgICBzdHJpcFVuZGVyc2NvcmU6IGZhbHNlXG4gICAgICAgIH0sIG9wdGlvbnMpO1xuXG4gICAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IFtdO1xuXG4gICAgICAgICAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKEV4dHJhY3Rvci5maXhOYW1pbmdDb252ZW50aW9uKG9iaiwgb3B0aW9ucykpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICByZXN1bHQgPSB7fTtcblxuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIGRhdGEpIHtcbiAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuc3RyaXBVbmRlcnNjb3JlIHx8IGtleS5jaGFyQXQoMCkgIT09ICdfJykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZmluYWxLZXkgPSBrZXk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMua2V5TmFtaW5nU3RyYXRlZ3kgPT09ICdzbmFrZV9jYXNlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxLZXkgPSBFeHRyYWN0b3IuY29udmVydFN0cmluZ1RvU25ha2VDYXNlKGtleSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGFba2V5XSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtmaW5hbEtleV0gPSBFeHRyYWN0b3IuZml4TmFtaW5nQ29udmVudGlvbihkYXRhW2tleV0sIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ZpbmFsS2V5XSA9IGRhdGFba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgLy8gRm9yIEpTT04gZWRpdG9yIG9ubHkuIFNob3VsZCBiZSBleHRyYWN0ZWQuXG4gICAgc3RhdGljIGNvbnZlcnREYXRhVG9TdHJpbmcoZGF0YTogYW55LCBjYWxsYmFja3M6IGFueSA9IHt9KSB7XG4gICAgICAgIGxldCByZXN1bHQgPSBudWxsO1xuXG4gICAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IFtdO1xuXG4gICAgICAgICAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKEV4dHJhY3Rvci5jb252ZXJ0RGF0YVRvU3RyaW5nKG9iaikpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICByZXN1bHQgPSB7fTtcblxuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIGRhdGEpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGFba2V5XSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFba2V5XSBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtrZXldID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGF0ZScgaW4gY2FsbGJhY2tzICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmRhdGUgaW5zdGFuY2VvZiBGdW5jdGlvbiA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5kYXRlKGRhdGFba2V5XSkgOiBkYXRhW2tleV0ueXl5eW1tZGQoJy0nKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gRXh0cmFjdG9yLmNvbnZlcnREYXRhVG9TdHJpbmcoZGF0YVtrZXldKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGFba2V5XSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IGRhdGFba2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHN0YXRpYyBjb252ZXJ0U3RyaW5nVG9TbmFrZUNhc2UodmFsdWUpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsdWUucmVwbGFjZSgvKFtBLVpdKykvZywgXCJfJDFcIikudG9Mb3dlckNhc2UoKTtcblxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG59XG5cbmxldCBFeHRyYWN0b3IgPSBPYmplY3RBdHRyaWJ1dGVUeXBlRXh0cmFjdG9yO1xuIl19